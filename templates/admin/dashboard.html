{% extends "base.html" %}
{% block title %}ç®¡ç†åå° Â· ä»ªè¡¨ç›˜{% endblock %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .admin-nav {
        background:var(--dark-blue); padding:12px 16px; display:flex; align-items:center; gap:16px; overflow-x:auto;
    }
    .admin-nav a {
        color:rgba(255,255,255,0.7); font-size:14px; text-decoration:none; white-space:nowrap; padding:6px 14px;
        border-radius:8px; transition:all 0.2s;
    }
    .admin-nav a:hover, .admin-nav a.active { background:rgba(255,255,255,0.12); color:#fff; }
    .admin-nav .brand { font-weight:700; color:#fff; font-size:16px; margin-right:auto; }
    .stat-card {
        background:#fff; border-radius:14px; padding:20px; flex:1; min-width:140px;
        box-shadow:0 2px 12px rgba(0,0,0,0.04);
    }
    .stat-card .label { font-size:13px; color:var(--text-grey); }
    .stat-card .value { font-size:28px; font-weight:800; margin-top:4px; }
    .chart-wrap { background:#fff; border-radius:14px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.04); margin-top:16px; }
    .order-row {
        display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #f5f5f5; gap:12px; font-size:14px;
    }
    .status-tag { padding:3px 10px; border-radius:12px; font-size:12px; font-weight:600; }
    .status-Pending { background:#fff3cd; color:#856404; }
    .status-Cooking { background:#fde2e2; color:#c0392b; }
    .status-Served { background:#d4edda; color:#155724; }
    .status-Paid { background:#d1ecf1; color:#0c5460; }
    .status-Cancelled { background:#f0f0f0; color:#999; }
    .action-btn {
        padding:4px 12px; border-radius:8px; font-size:12px; font-weight:600;
        border:none; cursor:pointer; transition:all 0.15s;
    }
    .action-btn:active { transform:scale(0.95); }
</style>
{% endblock %}

{% block body %}
<nav class="admin-nav">
    <span class="brand">ğŸ® å›½åº†é¤é¦†</span>
    <a href="/admin/" class="active">ä»ªè¡¨ç›˜</a>
    <a href="/admin/orders">è®¢å•</a>
    <a href="/admin/dishes">èœå“</a>
    <a href="/admin/tables">æ¡Œå°</a>
    <a href="/admin/reviews">è¯„ä»·</a>
    <a href="/admin/logout" style="color:rgba(255,255,255,0.4);">é€€å‡º</a>
</nav>

<div style="max-width:900px;margin:0 auto;padding:20px 16px;">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;" id="statsRow">
        <div class="stat-card">
            <div class="label">ä»Šæ—¥è¥ä¸šé¢</div>
            <div class="value text-gold font-price" id="statRevenue">--</div>
        </div>
        <div class="stat-card">
            <div class="label">ä»Šæ—¥è®¢å•</div>
            <div class="value" style="color:var(--dark-blue);" id="statOrders">--</div>
        </div>
        <div class="stat-card">
            <div class="label">å¾…å¤„ç†</div>
            <div class="value" style="color:var(--alert);" id="statPending">--</div>
        </div>
    </div>

    <!-- æ”¶å…¥è¶‹åŠ¿å›¾ -->
    <div class="chart-wrap">
        <h3 style="font-size:15px;font-weight:700;margin-bottom:12px;color:var(--dark-blue);">è¿‘7å¤©æ”¶å…¥è¶‹åŠ¿</h3>
        <canvas id="revenueChart" height="200"></canvas>
    </div>

    <!-- æ´»è·ƒè®¢å• -->
    <div style="margin-top:20px;">
        <h3 style="font-size:15px;font-weight:700;margin-bottom:12px;color:var(--dark-blue);">å½“å‰æ´»è·ƒè®¢å•</h3>
        <div id="ordersList" style="background:#fff;border-radius:14px;padding:12px 16px;box-shadow:0 2px 12px rgba(0,0,0,0.04);"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chart = null;

async function loadStats() {
    const res = await fetch('/admin/api/stats');
    const d = await res.json();
    document.getElementById('statRevenue').textContent = 'Â¥' + d.today_revenue.toFixed(2);
    document.getElementById('statOrders').textContent = d.today_orders;
    document.getElementById('statPending').textContent = d.pending_orders;
}

async function loadChart() {
    const res = await fetch('/admin/api/revenue_trend');
    const data = await res.json();
    const ctx = document.getElementById('revenueChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.date),
            datasets: [{
                label: 'æ”¶å…¥ (å…ƒ)',
                data: data.map(d => d.revenue),
                borderColor: '#D4AF37',
                backgroundColor: 'rgba(212,175,55,0.1)',
                borderWidth: 2.5,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#D4AF37',
                pointRadius: 4,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f5f5f5' } },
                x: { grid: { display: false } }
            }
        }
    });
}

async function loadOrders() {
    const res = await fetch('/admin/api/orders?status=active');
    const orders = await res.json();
    const el = document.getElementById('ordersList');
    if (!orders.length) { el.innerHTML = '<div style="text-align:center;color:#ccc;padding:24px;">æš‚æ— æ´»è·ƒè®¢å•</div>'; return; }
    el.innerHTML = orders.map(o => `
        <div class="order-row">
            <span style="font-weight:700;min-width:60px;">${o.table_name}</span>
            <span style="color:var(--text-grey);font-size:12px;">${o.created_at.slice(11,16)}</span>
            <span class="font-price" style="font-weight:600;color:var(--gold);">Â¥${o.total_amount.toFixed(1)}</span>
            <span class="status-tag status-${o.status}" style="margin-left:auto;">${statusText(o.status)}</span>
            ${o.status === 'Pending' ? `<button class="action-btn" style="background:#28A745;color:#fff;" onclick="updateStatus(${o.id},'Cooking')">æ¥å•</button>` : ''}
            ${o.status === 'Cooking' ? `<button class="action-btn" style="background:#17a2b8;color:#fff;" onclick="updateStatus(${o.id},'Served')">ä¸Šèœ</button>` : ''}
            ${o.status === 'Served' ? `<button class="action-btn" style="background:var(--gold);color:#fff;" onclick="updateStatus(${o.id},'Paid')">ç»“è´¦</button>` : ''}
        </div>
    `).join('');
}

function statusText(s) {
    return { Pending:'å¾…æ¥å•', Cooking:'åˆ¶ä½œä¸­', Served:'å·²ä¸Šèœ', Paid:'å·²æ”¯ä»˜', Cancelled:'å·²å–æ¶ˆ' }[s] || s;
}

async function updateStatus(orderId, status) {
    await fetch(`/admin/api/orders/${orderId}/status`, {
        method: 'PUT', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status })
    });
    loadOrders();
    loadStats();
}

// åˆå§‹åŒ– + æ¯15ç§’è½®è¯¢
loadStats(); loadChart(); loadOrders();
setInterval(() => { loadStats(); loadOrders(); }, 15000);
</script>
{% endblock %}
