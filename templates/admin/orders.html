{% extends "base.html" %}
{% block title %}ç®¡ç†åå° Â· è®¢å•ç®¡ç†{% endblock %}
{% block extra_head %}
<style>
    .admin-nav { background:var(--dark-blue); padding:12px 16px; display:flex; align-items:center; gap:16px; overflow-x:auto; }
    .admin-nav a { color:rgba(255,255,255,0.7); font-size:14px; text-decoration:none; white-space:nowrap; padding:6px 14px; border-radius:8px; transition:all 0.2s; }
    .admin-nav a:hover, .admin-nav a.active { background:rgba(255,255,255,0.12); color:#fff; }
    .admin-nav .brand { font-weight:700; color:#fff; font-size:16px; margin-right:auto; }
    .filter-bar { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
    .filter-btn { padding:6px 16px; border-radius:20px; border:1.5px solid #e0e0e0; background:#fff; font-size:13px; cursor:pointer; transition:all 0.2s; }
    .filter-btn.active { border-color:var(--gold); background:var(--gold-light); color:var(--dark-blue); font-weight:600; }
    .order-card { background:#fff; border-radius:14px; padding:16px; margin-bottom:12px; box-shadow:0 2px 12px rgba(0,0,0,0.04); }
    .order-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .order-items { font-size:13px; color:var(--text-grey); line-height:1.8; }
    .status-tag { padding:3px 10px; border-radius:12px; font-size:12px; font-weight:600; display:inline-block; }
    .status-Pending { background:#fff3cd; color:#856404; }
    .status-Cooking { background:#fde2e2; color:#c0392b; }
    .status-Served { background:#d4edda; color:#155724; }
    .status-Paid { background:#d1ecf1; color:#0c5460; }
    .status-Cancelled { background:#f0f0f0; color:#999; }
    .action-btn { padding:6px 14px; border-radius:8px; font-size:13px; font-weight:600; border:none; cursor:pointer; margin-right:6px; }
</style>
{% endblock %}

{% block body %}
<nav class="admin-nav">
    <span class="brand">ğŸ® å›½åº†é¤é¦†</span>
    <a href="/admin/">ä»ªè¡¨ç›˜</a>
    <a href="/admin/orders" class="active">è®¢å•</a>
    <a href="/admin/dishes">èœå“</a>
    <a href="/admin/tables">æ¡Œå°</a>
    <a href="/admin/reviews">è¯„ä»·</a>
    <a href="/admin/logout" style="color:rgba(255,255,255,0.4);">é€€å‡º</a>
</nav>
<div style="max-width:700px;margin:0 auto;padding:20px 16px;">
    <h2 style="font-size:18px;font-weight:700;margin-bottom:16px;">è®¢å•ç®¡ç†</h2>
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterOrders('active',this)">æ´»è·ƒè®¢å•</button>
        <button class="filter-btn" onclick="filterOrders('Paid',this)">å·²å®Œæˆ</button>
        <button class="filter-btn" onclick="filterOrders('Cancelled',this)">å·²å–æ¶ˆ</button>
        <button class="filter-btn" onclick="filterOrders('all',this)">å…¨éƒ¨</button>
    </div>
    <div id="ordersList"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFilter = 'active';

async function filterOrders(status, btn) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    await loadOrders();
}

async function loadOrders() {
    const res = await fetch('/admin/api/orders?status=' + currentFilter);
    const orders = await res.json();
    const el = document.getElementById('ordersList');
    if (!orders.length) { el.innerHTML = '<div style="text-align:center;color:#ccc;padding:40px;">æš‚æ— è®¢å•</div>'; return; }
    el.innerHTML = orders.map(o => `
        <div class="order-card fade-in">
            <div class="order-header">
                <span style="font-weight:700;font-size:15px;">#${o.id}</span>
                <span style="font-weight:600;">${o.table_name}</span>
                <span style="color:var(--text-grey);font-size:12px;">${o.created_at}</span>
                <span class="status-tag status-${o.status}" style="margin-left:auto;">${statusText(o.status)}</span>
            </div>
            <div class="order-items">
                ${o.items.map(i => `${i.dish_name} Ã— ${i.quantity}`).join('ã€')}
                ${o.customer_note ? `<br>ğŸ“ ${o.customer_note}` : ''}
            </div>
            <div style="display:flex;align-items:center;margin-top:10px;">
                <span class="font-price" style="font-size:18px;font-weight:700;color:var(--gold);">Â¥${o.total_amount.toFixed(2)}</span>
                <div style="margin-left:auto;">
                    ${o.status === 'Pending' ? `<button class="action-btn" style="background:#28A745;color:#fff;" onclick="updateStatus(${o.id},'Cooking')">æ¥å•</button><button class="action-btn" style="background:#DC3545;color:#fff;" onclick="updateStatus(${o.id},'Cancelled')">å–æ¶ˆ</button>` : ''}
                    ${o.status === 'Cooking' ? `<button class="action-btn" style="background:#17a2b8;color:#fff;" onclick="updateStatus(${o.id},'Served')">å·²ä¸Šèœ</button>` : ''}
                    ${o.status === 'Served' ? `<button class="action-btn" style="background:var(--gold);color:#fff;" onclick="updateStatus(${o.id},'Paid')">ç»“è´¦</button>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function statusText(s) { return {Pending:'å¾…æ¥å•',Cooking:'åˆ¶ä½œä¸­',Served:'å·²ä¸Šèœ',Paid:'å·²æ”¯ä»˜',Cancelled:'å·²å–æ¶ˆ'}[s]||s; }

async function updateStatus(id, status) {
    await fetch(`/admin/api/orders/${id}/status`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status}) });
    loadOrders();
}

loadOrders();
setInterval(loadOrders, 15000);
</script>
{% endblock %}
